

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asset Link docs assetlink-plugin-dev-support/src/index.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="./custom-styles.css">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
             
                <a class="image" href="index.html">
                    <img src="https://user-images.githubusercontent.com/30754460/184543756-4bbd5d3b-7a87-487b-b2ab-5d7244e728ac.png" alt="logo">
                </a>
            
             
                <a href="index.html">
                    <h1 class="navbar-item">Asset Link</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                <div class="dropdown is-hoverable is-right">
                    <a class="dropdown-trigger link">
                        Tutorials
                        <i class="fas fa-chevron-down fa-xs"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-content">
                        
                            <a class="dropdown-item" href="tutorial-user-guide.html">
                                User Guide
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-development.html">
                                Development
                            </a>
                        
                        </div>
                    </div>
                </div>
                
                 
                    
                        <a
                            class="link user-link "
                            href="https://github.com/symbioquine/farmOS_asset_link"
                        >
                            Github
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://www.npmjs.com/package/assetlink-plugin-api"
                        >
                            Plugin API ðŸ“¦
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://www.npmjs.com/package/assetlink-plugin-dev-support"
                        >
                            Dev Support ðŸ“¦
                        </a>
                    
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Externals</h3><ul><li><a href="external-@orbit_jsonapi.html">@orbit/jsonapi</a></li><li><a href="external-@orbit_memory.html">@orbit/memory</a></li><li><a href="external-localForage.html">localForage</a></li><li><a href="external-Promise.html">Promise</a></li><li><a href="external-URL.html">URL</a></li></ul><h3>Classes</h3><ul><li><a href="external-@orbit_jsonapi.JSONAPISource.html">JSONAPISource</a></li><li><a href="external-@orbit_memory.MemorySource.html">MemorySource</a></li></ul><h3>Interfaces</h3><ul><li><a href="IAssetLink.html">IAssetLink</a></li><li><a href="IAssetLinkPlugin.html">IAssetLinkPlugin</a></li><li><a href="IAssetLinkPluginHandle.html">IAssetLinkPluginHandle</a></li><li><a href="IAssetLinkPluginIngestorHandle.html">IAssetLinkPluginIngestorHandle</a></li><li><a href="IAssetLinkPluginRouteHandle.html">IAssetLinkPluginRouteHandle</a></li><li><a href="IAssetLinkPluginSlotHandle.html">IAssetLinkPluginSlotHandle</a></li><li><a href="IAssetLinkPluginWidgetDecoratorHandle.html">IAssetLinkPluginWidgetDecoratorHandle</a></li><li><a href="IAssetLinkUI.html">IAssetLinkUI</a></li><li><a href="IAssetLinkUIDialogs.html">IAssetLinkUIDialogs</a></li><li><a href="IFarmOSConnectionStatus.html">IFarmOSConnectionStatus</a></li></ul><h3>Global</h3><ul><li><a href="global.html#assetLinkIncludedLibraries">assetLinkIncludedLibraries</a></li><li><a href="global.html#components">components</a></li><li><a href="global.html#createDevServerConfig">createDevServerConfig</a></li><li><a href="global.html#createDrupalUrl">createDrupalUrl</a></li><li><a href="global.html#currentEpochSecond">currentEpochSecond</a></li><li><a href="global.html#EventBus">EventBus</a></li><li><a href="global.html#GenerateDefaultPluginConfigYmlFilesPlugin">GenerateDefaultPluginConfigYmlFilesPlugin</a></li><li><a href="global.html#getDrupalBasePath">getDrupalBasePath</a></li><li><a href="global.html#summarizeAssetNames">summarizeAssetNames</a></li></ul></div><div class="category"><h2>components</h2><h3>Modules</h3><ul><li><a href="module-EntityName.html">EntityName</a></li><li><a href="module-EntityResolver.html">EntityResolver</a></li><li><a href="module-EntitySearch.html">EntitySearch</a></li><li><a href="module-EntitySelect.html">EntitySelect</a></li><li><a href="module-PhotoInput.html">PhotoInput</a></li><li><a href="module-QrCodeScanner.html">QrCodeScanner</a></li><li><a href="module-RenderWidget.html">RenderWidget</a></li><li><a href="module-SearchMethod.html">SearchMethod</a></li><li><a href="module-SearchMethodTileTabber.html">SearchMethodTileTabber</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>assetlink-plugin-dev-support/src/index.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const https = require('https');
const glob = require('glob');
const chokidar = require('chokidar');
const yaml = require('js-yaml');
const path = require('path');


const SERVE_DEV_HOST = process.env.ASSET_LINK_PLUGIN_SERVING_DEV_HOST || 'http://farmos.test';

/**
 * Libraries that are available for import in Asset Link plugins.
 * 
 * 'buffer/' 6.0.3 - https://www.npmjs.com/package/buffer
 * 'assetlink-plugin-api' - https://symbioquine.github.io/farmOS_asset_link/global.html
 * 'vue' 3.0.0 - https://vuejs.org/api/
 * 'vue-router' 4.0.0 - https://router.vuejs.org/api/
 * 'quasar' 2.6.0 - https://quasar.dev/docs
 * 'ngeohash' 0.6.3 - https://www.npmjs.com/package/ngeohash
 * 'haversine-distance' 1.2.1 - https://www.npmjs.com/package/haversine-distance
 * 'jmespath' 0.16.0 - https://www.npmjs.com/package/jmespath
 * 'micromustache' 8.0.3 - https://www.npmjs.com/package/micromustache
 * 
 * ### Usage in webpack.config.js
 * 
 * ```js
 * const { assetLinkIncludedLibraries } = require('assetlink-plugin-dev-support');
 * 
 * module.exports = {
 *   ...
 *   externals: {
 *     ...assetLinkIncludedLibraries,
 *   }
 * };
 * ```
 * 
 * ### Usage in Plugins
 *
 * ```js
 * import { h } from 'vue';
 * import { QBtn } from 'quasar';
 * ```
 */
module.exports.assetLinkIncludedLibraries = {
  'buffer/': 'buffer/',
  'assetlink-plugin-api': 'assetlink-plugin-api',
  'vue': 'vue',
  'vue-router': 'vue-router',
  'quasar': 'quasar',
  'ngeohash': 'ngeohash',
  'haversine-distance': 'haversine-distance',
  'jmespath': 'jmespath',
  'micromustache': 'micromustache',
}

/**
 * Custom Webpack plugin to generate configuration entity yml files for each of our included
 * Asset Link plugins.
 * 
 * ### Usage
 *
 * ```js
 * const { GenerateDefaultPluginConfigYmlFilesPlugin } = require('assetlink-plugin-dev-support');
 * 
 * module.exports = {
 *   ...
 *   plugins: [
 *     new GenerateDefaultPluginConfigYmlFilesPlugin({
 *       pluginDir: __dirname,
 *       // This must match your drupal module name for Asset Link to be able to serve your plugins
 *       drupalModuleName: 'example_alink_plugins',
 *     }),
 *   ]
 * };
 * ```
 */
function GenerateDefaultPluginConfigYmlFilesPlugin(options) {
  if (!options?.pluginDir) {
    throw new Error('options.pluginDir must be specified with the local directory where the plugins are located.');
  }

  if (!options?.drupalModuleName) {
    throw new Error('options.drupalModuleName must be specified with the name of the drupal module which will provide these plugins and yaml files.');
  }

  GenerateDefaultPluginConfigYmlFilesPlugin.prototype.apply = (compiler) => {
    compiler.hooks.afterEmit.tap('GenerateDefaultPluginConfigYmlFilesPlugin', (compilation) => {

      const configOutputDir = options.configOutputDir || `${options.pluginDir}/config/install`;

      if (!fs.existsSync(configOutputDir)) {
        fs.mkdirSync(configOutputDir, { recursive: true });
      }

      const existingConfigFiles = glob.sync(`${configOutputDir}/farmos_asset_link.asset_link_default_plugin.*.yml`);
      existingConfigFiles.forEach(f => fs.unlinkSync(f));

      fs.readdirSync(options.pluginDir).forEach(filename => {
        if (filename.indexOf('.alink.') === -1) {
          return;
        }

        const nameWithoutExt = filename.replace(/(\.[^.]+)*$/, '');

        const configOutputFilename = `${configOutputDir}/farmos_asset_link.asset_link_default_plugin.${nameWithoutExt}.yml`;

        fs.writeFileSync(configOutputFilename, yaml.dump({
          langcode: 'en',
          status: true,
          id: nameWithoutExt,
          dependencies: { enforced: { module: [ options.drupalModuleName ] } },
          url: `{module:${options.drupalModuleName}}/${filename}`,
          user_defined : null,
        }));
      });

    });
  };
}
module.exports.GenerateDefaultPluginConfigYmlFilesPlugin = GenerateDefaultPluginConfigYmlFilesPlugin;

/**
 * Generate a Webpack dev server configuration to serve our plugins with live-reload and (optionally) https.
 * 
 * ### Usage
 *
 * ```js
 * const { createDevServerConfig } = require('assetlink-plugin-dev-support');
 * 
 * module.exports = {
 *   ...
 *   devServer: createDevServerConfig({
 *     pluginDir: __dirname,
 *   }),
 * };
 * ```
 */
const createDevServerConfig = (options) => {
  if (!options?.pluginDir) {
    throw new Error('options.pluginDir must be specified with the local directory where the plugins to be hosted are located.');
  }

  const targetUrl = new URL(SERVE_DEV_HOST);

  const devHost = targetUrl.hostname;

  let serverPort;

  let serverConfig = {
    hot: false,
    liveReload: false,
    webSocketServer: 'ws',
    allowedHosts: "all",
    setupMiddlewares: function (middlewares, devServer) {
      if (!devServer) {
        throw new Error('webpack-dev-server is not defined');
      }

      const compiledPlugins = {};

      const getPluginFilenames = () => Array.from(new Set([
        ...Object.keys(compiledPlugins),
        ...fs.readdirSync(`${options.pluginDir}/`).filter(filename => filename.indexOf('.alink.') !== -1),
      ])).filter(filename => !filename.endsWith('LICENSE.txt'));

      devServer.app.get('/plugins.repo.json', (_, res) => {
        const repo = {};

        const wsProtocol = (targetUrl.protocol === "https:") ? 'wss' : 'ws';
        repo.updateChannel = `${wsProtocol}://${devHost}:${serverPort}/ws`;

        repo.plugins = getPluginFilenames().map(pluginFilename => ({url: `/plugins/${pluginFilename}`})),

        res.set({
          ...serverConfig.headers,
        });

        res.json(repo);
      });

      const handlePluginRequest = (req, res) => {
        // Make sure the specified plugin is actual among the ones we're trying to host
        const pluginMatch = getPluginFilenames().find(filename => filename === req.params.pluginFilename);

        if (!pluginMatch) {
          return res.status(404).json({ error: 'No Such plugin' });
        }

        res.set({
          ...serverConfig.headers,
        });

        if (Object.hasOwn(compiledPlugins, req.params.pluginFilename)) {
          res.send(compiledPlugins[req.params.pluginFilename]);
          return;
        }

        res.send(fs.readFileSync(`${options.pluginDir}/${pluginMatch}`));
      };

      devServer.app.options('/plugins/:pluginFilename', handlePluginRequest);
      devServer.app.get('/plugins/:pluginFilename', handlePluginRequest);

      const files = [`${options.pluginDir}/*.alink.*`];
      console.log(files);
      chokidar
        .watch(files, {
          alwaysStat: true,
          atomic: false,
          followSymlinks: false,
          ignoreInitial: true,
          ignorePermissionErrors: true,
          persistent: true,
          usePolling: true,
        })
        .on("all", (event, pluginFilePath) => {
          const fileName = path.basename(pluginFilePath);
    
          const pluginUrl = `${targetUrl.protocol}//${devHost}:${serverPort}/plugins/${fileName}`;

          const eventToSend = (event === 'unlink') ? 'asset-link-plugin-removed' : 'asset-link-plugin-changed';

          devServer.sendMessage(devServer.webSocketServer.clients, eventToSend, pluginUrl);
        });

      devServer.compiler.hooks.assetEmitted.tap('ServeCompiledPlugins',
        (fileName, { content, source, outputPath, compilation, targetPath }) => {
          if (fileName.includes('hot-update') || fileName.endsWith('LICENSE.txt')) {
            return;
          }

          compiledPlugins[fileName] = content;

          const pluginUrl = `${targetUrl.protocol}//${devHost}:${serverPort}/plugins/${fileName}`;

          devServer.sendMessage(devServer.webSocketServer.clients, 'asset-link-plugin-changed', pluginUrl);
        }
      );

      return middlewares;
    },
    headers: {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET",
      "Access-Control-Allow-Headers": "*",
    },
    onListening: (devServer) => {
      serverPort = devServer.server.address().port;
    },
  };

  if (targetUrl.protocol === "https:") {
    const devRootCA = `${options.pluginDir}/devcerts/rootCA.pem`;

    https.globalAgent.options.ca = https.globalAgent.options.ca || [];
    https.globalAgent.options.ca.push(fs.readFileSync(devRootCA));

    Object.assign(serverConfig, {
      server: {
        type: "https",
        options: {
          ca: devRootCA,
          key: `${options.pluginDir}/devcerts/${devHost}/privkey.pem`,
          cert: `${options.pluginDir}/devcerts/${devHost}/fullchain.pem`,
        },
      },
      host: devHost,
    });
  }

  return serverConfig;
};
module.exports.createDevServerConfig = createDevServerConfig;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>


</body>
</html>
