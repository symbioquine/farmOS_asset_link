export default class BasicAssetLogPluginFormat{onLoad(e,t){e.definePluginIngestor((n=>{n.onEveryPlugin((n=>{n.pluginUrl.pathname.endsWith("alink.act.json")&&e.onBehalfOf(n,(e=>{let s;try{s=JSON.parse(n.rawSource)}catch(a){return void e.recordError(a)}if("com.example.farmos_asset_link.plugin_format.v0.basic_asset_log"!==s.AssetLinkPluginFormat)return;const o={};for(const[t,n]of Object.entries(s.appliesTo||{})){if("$null"===n){o[t]=e=>null===e||void 0===e;continue}const s=n.split("$$"),r=s.find((e=>-1!==e.indexOf("$")));if(r)return void e.recordError(`Invalid expression command: '${r}' Only escaped dollar signs '$$' or the '$null' command are currently supported.`);const a=s.join("$");o[t]=e=>e===a}const r=(e,t)=>{const n=t.split(".");let s,o=e;while(o&&n.length>0){const e=n.shift();o=o[e],n.length||(s=o)}return s};e.defineSlot(`com.example.farmos_asset_link.basic_asset_log.v0.${s.id}`,(e=>{e.type("asset-action"),e.showIf((({asset:e})=>{for(const[t,n]of Object.entries(o)){const s=r(e,t);if(!n(s))return!1}return!0}));const n=t.util.formatRFC3339,a=async e=>{let o={};for(const[t,n]of Object.entries(s.createLog)){const s=t.split(".");let a=o;while(s.length>1){const e=s.shift();a[e]||(a[e]={}),a=a[e]}const i=s[0];a[i]=n.replace(/\{\{\s*([^\s]*)\s*\}\}/,((t,n)=>r({asset:e},n)))}o.timestamp=n(new Date),o.relationships={asset:{data:[{type:e.type,id:e.id}]}},t.entitySource.update((e=>e.addRecord(o)),{label:o.attributes.name})},i=t.ui.c.VBtn;e.componentFn(((e,t,{asset:n})=>t(i,{props:{block:!0,color:"secondary"},on:{click:()=>a(n)},class:"text-none"},s.name)))}))}))}))}))}}