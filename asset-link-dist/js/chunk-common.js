"use strict";(self["webpackChunkalinkjs"]=self["webpackChunkalinkjs"]||[]).push([[64],{7251:function(e,t,i){i.d(t,{Z:function(){return ue}});var n=i(538),s=i(1833),r=i(407),o=i(3864),a=i(9849),l=i(4634),c=i(8898),u=i(3396),d=i(5480),h=(i(1703),i(7132));class g extends u.$H{constructor(e){super(e)}buildFilterParam(e){const t=[];return e.forEach(((e,i)=>{if("attribute"===e.kind&&"equal"===e.op){const i=e,n=this.serializeAttributeAsParam(void 0,i.attribute);t.push({[n]:i.value})}else if("attribute"===e.kind){const n=e,s=this.serializeAttributeAsParam(void 0,n.attribute);t.push({["client-"+s+"-"+i]:{path:s,operator:n.op,value:n.value}})}else if("relatedRecord"===e.kind){const i=e;Array.isArray(i.record)?t.push({[i.relation]:i.record.map((e=>e.id)).join(",")}):t.push({[i.relation]:i?.record?.id})}else{if("relatedRecords"!==e.kind)throw new h.gT(`Filter operation ${e.op} not recognized for JSONAPISource.`);{if("equal"!==e.op)throw new Error(`Operation "${e.op}" is not supported in JSONAPI for relatedRecords filtering`);const i=e;t.push({[i.relation]:i.records.map((e=>e.id)).join(",")})}}})),t}serializeAttributeAsParam(e,t){if(this.serializer)return this.serializer.resourceAttribute(e,t);{const i=this.serializerFor(u.pi.ResourceFieldParam);return i.serialize(t,{type:e})}}}class p extends u.ZP{constructor(e){const t=Object.assign({},e.defaultFetchSettings||{},{headers:{Accept:"application/vnd.api+json","Content-Type":"application/vnd.api+json"}});super(Object.assign({},e,{defaultFetchSettings:t,serializerSettingsFor:(0,d.yk)({sharedSettings:{inflectors:{drupal:(0,d.PH)({},(e=>e.replace("--","/")))}},settingsByType:{[u.pi.ResourceTypePath]:{serializationOptions:{inflectors:["drupal"]}}}}),URLBuilderClass:g}))}}var f=i(6051),m=i(793),_={findRecord:f.CN.findRecord,findRelatedRecord:f.CN.findRelatedRecord,findRecords(e,t,i){let n=t,s=e.getRecordsSync(n.records||n.type);return n.filter&&(s=w(s,n.filter)),n.sort&&(s=v(s,n.sort)),n.page&&(s=b(s,n.page)),s},findRelatedRecords(e,t,i){const n=t,{record:s,relationship:r}=n,o=e.getRelatedRecordsSync(s,r);if(!o||0===o.length){if(!e.getRecordSync(s)){if(i?.raiseNotFoundExceptions)throw new l.dR(s.type,s.id);return}return[]}let a=e.getRecordsSync(o);return n.filter&&(a=w(a,n.filter)),n.sort&&(a=v(a,n.sort)),n.page&&(a=b(a,n.page)),a}};function w(e,t){return e.filter((e=>{for(let i=0,n=t.length;i<n;i++)if(!y(e,t[i]))return!1;return!0}))}function y(e,t){if("attribute"===t.kind){let i=t.attribute.split("."),n=(0,m.In)(e,["attributes",...i]),s=t.value;switch(t.op){case"equal":case"=":return"string"===typeof n?n.toLowerCase()===s.toLowerCase():n===s;case"<>":return"string"===typeof n?n.toLowerCase()!==s.toLowerCase():n!==s;case">":return n>s;case">=":return n>=s;case"<":return n<s;case"<=":return n<=s;case"STARTS_WITH":return"string"===typeof n&&n.toLowerCase().startsWith(s.toLowerCase());case"CONTAINS":return"string"===typeof n&&n.toLowerCase().includes(s.toLowerCase());case"ENDS_WITH":return"string"===typeof n&&n.toLowerCase().endsWith(s.toLowerCase());case"IN":case"NOT IN":case"BETWEEN":case"NOT BETWEEN":throw new h.gT(`Filter operation ${t.op} is not yet implemented for Store.`);case"IS NULL":return void 0===n||null===n;case"IS NOT NULL":return void 0!==n&&null!==n;default:throw new h.gT(`Filter operation ${t.op} not recognized for Store.`)}}return f.CN.applyFilter(e,t)}function v(e,t){const i=new Map;e.forEach((e=>{i.set(e,t.map((t=>{if("attribute"===t.kind){let i=t.attribute.split(".");return(0,m.In)(e,["attributes",...i])}throw new h.gT("Sort specifier ${sortSpecifier.kind} not recognized for Store.")})))}));const n=t.map((e=>"descending"===e.order?-1:1));return e.sort(((e,s)=>{const r=i.get(e),o=i.get(s);for(let i=0;i<t.length;i++){if(r[i]<o[i])return-n[i];if(r[i]>o[i])return n[i];if((0,m.Wi)(r[i])&&!(0,m.Wi)(o[i]))return n[i];if((0,m.Wi)(o[i])&&!(0,m.Wi)(r[i]))return-n[i]}return 0}))}function b(e,t){if(void 0!==t.limit){let i=void 0===t.offset?0:t.offset,n=t.limit;return e.slice(i,i+n)}throw new h.gT("Pagination options not recognized for Store. Please specify `offset` and `limit`.")}var P=i(9483),L=i.n(P),S=i(4098),k=i.n(S),R=i(7056),x=i(4462),$=i(6619),I=i(7068),T=i(5934);class F{constructor(e){this._app=e}get c(){return{VBtn:R.Z,VListItem:x.Z,VListItemTitle:$.V9}}get dialog(){return{confirm:async e=>await this._app.$dialog.confirm({text:e,title:"Confirmation"}),promptText:async e=>await this._app.$dialog.prompt({text:e,title:"Input"}),custom:async(e,t)=>{const i=(0,T.Z)(),s=new n.Z({}),r=await new Promise((n=>{s.$on("submit",n),this._app.dialogs.push({id:i,context:s,componentFn:(i,s)=>s(I.Z,{props:{value:!0,fullscreen:!0},on:{input:()=>n(void 0)}},[s(e,{ref:"dialogComponent",...t})])})}));return this._app.dialogs=this._app.dialogs.filter((e=>e.id!==i)),r}}}}var E=i(3210),O=i(7441),C=i(5396),A=i.n(C),N=i(901),j=i.n(N);class U{get formatRFC3339(){return E.Z}get createDrupalUrl(){return O.Z}get geohash(){return A()}get haversine(){return j()}summarizeAssetNames(e){return e.length<=3?e.map((e=>e.attributes.name)).join(", "):`${e[0].attributes.name} (+${e.length-1} more)`}}var M=i(4752),D=i.n(M);const W=n.Z.extend({props:{fetcherDelegate:{type:Object,default:function(){return{fetch:k()}}}},data(){return{$_running:!1,$_barrier:new V,hasNetworkConnection:window.navigator.onLine,canReachFarmOS:void 0,isLoggedIn:void 0}},created(){window.addEventListener("offline",(()=>{this.hasNetworkConnection=!1,this.canReachFarmOS=!1})),window.addEventListener("online",(()=>{this.hasNetworkConnection=!0,this.$data.$_barrier.release()})),window.navigator&&window.navigator.connection&&window.navigator.connection.addEventListener("change",(()=>this.$data.$_barrier.release())),this.$_mainLoop()},computed:{isOnline(){return this.canReachFarmOS&&this.isLoggedIn}},beforeDestroy(){this.$data.$_running=!1,this.$data.$_barrier.release()},methods:{async fetch(e,t){const i=t||{};i.method||(i.method="GET");const n=new URL(e,window.location.origin+window.assetLinkDrupalBasePath),s=n.host===window.location.host&&n.pathname.startsWith(window.assetLinkDrupalBasePath);try{const t=await this.fetcherDelegate.fetch(e,i);return s&&403===t.status&&this.$data.$_barrier.release(),t}catch(r){throw s&&this.$data.$_barrier.release(),r}},async $_mainLoop(){this.$data.$_running=!0;const e=D()((()=>this.$_checkConnectionStatus()),1e3);while(this.$data.$_running)await e(),await this.$data.$_barrier.arrive(6e4)},async $_checkConnectionStatus(){if(!this.hasNetworkConnection)return;const e=(0,O.Z)(`api?cacheBust=${Z()}`);try{const t=await k()(e,{credentials:"same-origin",cache:"no-cache"});if(200!==t.status)return void(this.canReachFarmOS=!1);const i=await t.json(),n=i.meta?.farm?.version;if("2.x"!==n)return void(this.canReachFarmOS=!1);this.canReachFarmOS=!0;const s=i.meta?.links?.me?.href;this.isLoggedIn=void 0!==s}catch(t){this.canReachFarmOS=!1}}}});function B(e){return new Promise((t=>setTimeout(t,e)))}function Z(){return parseInt((new Date).getTime()/1e3)}class V{constructor(){this.waiting=[]}arrive(e){return Promise.race([B(e),new Promise((e=>this.waiting.push(e)))])}release(){const e=this.waiting.splice(0);e.forEach((e=>e()))}}var q=W;class z{constructor(e){this._delegate=e,this._next_iteration_result=void 0}async next(){if(void 0!==this._next_iteration_result){const e=this._next_iteration_result;return this._next_iteration_result=void 0,e}return await this._delegate.next()}async peek(){return void 0===this._next_iteration_result&&(this._next_iteration_result=await this._delegate.next()),this._next_iteration_result}}i(6314);function Q(){return parseInt((new Date).getTime()/1e3)}class K{constructor(){this._handlersByEventName={}}$on(e,t){Object.hasOwn(this._handlersByEventName,e)||(this._handlersByEventName[e]=[]),this._handlersByEventName[e].push(t)}async $emit(e,t){const i=this._handlersByEventName[e]||[],n=i.map((e=>e(t)));return Promise.all(n).then((()=>!0))}}class H extends Error{constructor(e,t){super(e,t)}}class J{constructor(e){this._store=e._store,this._vm=new n.Z({data:{lists:[]}}),this._eventBus=new K,this._pluginReferenceTracker=new G(this._eventBus),this._defaultPluginList=new X(e._store,(0,O.Z)("/alink/backend/default-plugins.repo.json"),this._pluginReferenceTracker,!0),this._localPluginList=new Y(e._store,this._pluginReferenceTracker),this._extraPluginLists=[],this._extraPluginListStoreKey="asset-link-extra-plugin-lists"}get vm(){return this._vm}get eventBus(){return this._eventBus}async boot(){const e=await this._getExtraPluginListUrls();this._extraPluginLists=e.map((e=>new X(this._store,e,this._pluginReferenceTracker,!1)));for(let t of[this._defaultPluginList,this._localPluginList,...this._extraPluginLists]){const e=await t.load();this._updatePluginListViewInViewModel(e)}}async addPluginToLocalList(e){const t=await this._localPluginList.addPlugin(e);this._updatePluginListViewInViewModel(t)}async removePluginFromLocalList(e){const t=await this._localPluginList.removePlugin(e);this._updatePluginListViewInViewModel(t)}async addExtraPluginList(e){this._modifyAndWriteStoredExtraPluginListUrls((t=>{const i=t.findIndex((t=>t===e));if(i>=0)return!1;t.push(e)}));const t=this._extraPluginLists.findIndex((t=>t._url===e));if(t>=0)return;const i=new X(this._store,e,this._pluginReferenceTracker,!1);this._extraPluginLists.push(i);const n=await i.load();this._updatePluginListViewInViewModel(n)}async removeExtraPluginList(e){this._modifyAndWriteStoredExtraPluginListUrls((t=>{const i=t.findIndex((t=>t===e));if(i<0)return!1;t.splice(i,1)}));const t=this._extraPluginLists.findIndex((t=>t._url===e));if(t<0)return;const i=this._extraPluginLists.splice(t,1)[0];await i.unload(),this._removePluginListViewFromViewModel(e)}async reloadPluginList(e){const t=[this._defaultPluginList,this._localPluginList,...this._extraPluginLists].find((t=>t._url===e));if(!t)return;const i=await t.reload();this._updatePluginListViewInViewModel(i)}async _getExtraPluginListUrls(){const e=await this._store.getItem(this._extraPluginListStoreKey);return e?e.value.map((e=>new URL(e))):[]}async _modifyAndWriteStoredExtraPluginListUrls(e){const t=await this._getExtraPluginListUrls(),i=!1!==e(t);return i&&await this._store.setItem(this._extraPluginListStoreKey,{key:this._extraPluginListStoreKey,timestamp:Q(),value:t}),t}_updatePluginListViewInViewModel(e){const t=this.vm,i=t.lists.findIndex((t=>t.sourceUrl===e.sourceUrl));i>=0?t.lists.splice(i,1,e):t.lists.push(e)}_removePluginListViewFromViewModel(e){const t=this.vm,i=t.lists.findIndex((t=>t.sourceUrl===e));i>=0&&t.lists.splice(i,1)}}class G{constructor(e){this._eventBus=e,this._pluginReferences={}}async ackPluginReference(e,t){const i=Object.hasOwn(this._pluginReferences,e.toString());i||(this._pluginReferences[e.toString()]=[]);const n=this._pluginReferences[e.toString()],s=n.indexOf(t.toString());s<0&&n.push(t),i||await this._eventBus.$emit("add-plugin",e)}async freePluginReference(e,t){const i=this._pluginReferences[e.toString()];if(!i)return void console.log("freePluginReference unexpectedly found plugin missing from internal reference tracking",e.toString(),t.toString(),JSON.stringify(this._pluginReferences));const n=i.indexOf(t.toString());n>=0?i.splice(n,1):console.log("freePluginReference unexpectedly found plugin without expected reference",e.toString(),t.toString(),JSON.stringify(i)),i.length>0||await this._eventBus.$emit("remove-plugin",e)}}class X{constructor(e,t,i,n){this._store=e,this._storeKey=`asset-link-cached-plugin-list:${t}`,this._url=t,this._pluginReferenceTracker=i,this._isDefault=n,this._isLocal=!1,this._latestPluginListView=void 0}async load(e){return this._latestPluginListView=ee(await this._getHttpPluginList(e),this._isDefault,this._isLocal,this._url),await Promise.all(this._latestPluginListView.plugins.map((e=>this._pluginReferenceTracker.ackPluginReference(e.url,this._url)))),this._latestPluginListView}async unload(){this._latestPluginListView&&(await Promise.all(this._latestPluginListView.plugins.map((e=>this._pluginReferenceTracker.freePluginReference(e.url,this._url)))),await this._store.removeItem(this._storeKey))}async reload(){return await this.load(!0)}async _getHttpPluginList(e){const t=e?void 0:await this._store.getItem(this._storeKey),i=Q();if(t&&i-t.timestamp<900)return t.value;const n=await fetch(this._url);if(console.log(n),403===n.status)throw new H(`HTTP Error ${n.status}: ${n.statusText}`);if(!n.ok)throw new Error(`HTTP Error ${n.status}: ${n.statusText}`);const s=await n.json();return await this._store.setItem(this._storeKey,{key:this._storeKey,timestamp:i,value:s}),s}}class Y{constructor(e,t){this._store=e,this._storeKey="local-plugin-list.repo.json",this._url=new URL("indexeddb://asset-link/data/local-plugin-list.repo.json",window.location.origin),this._isDefault=!1,this._isLocal=!0,this._pluginReferenceTracker=t}async load(){const e=ee(await this._getLocalPluginList(),this._isDefault,this._isLocal,this._url);return await Promise.all(e.plugins.map((e=>this._pluginReferenceTracker.ackPluginReference(e.url,this._url)))),e}async reload(){return await this.load()}async addPlugin(e){const t=await this._modifyAndWriteStoredList((t=>{if(t.plugins.find((t=>t.url===e.toString())))return!1;t.plugins.push({url:e.toString()})}));return await this._pluginReferenceTracker.ackPluginReference(e,this._url),ee(t,this._isDefault,this._isLocal,this._url)}async removePlugin(e){const t=await this._modifyAndWriteStoredList((t=>{const i=t.plugins.findIndex((t=>t.url===e.toString()));if(i<0)return!1;t.plugins.splice(i,1)}));return await this._pluginReferenceTracker.freePluginReference(e,this._url),ee(t,this._isDefault,this._isLocal,this._url)}async _getLocalPluginList(){const e=await this._store.getItem(this._storeKey);return e?e.value:{plugins:[]}}async _modifyAndWriteStoredList(e){const t=await this._getLocalPluginList(),i=!1!==e(t);return i&&await this._store.setItem(this._storeKey,{key:this._storeKey,timestamp:Q(),value:t}),t}}const ee=(e,t,i,n)=>(e.isDefault=t,e.isLocal=i,e.sourceUrl=n,e.error||(e.error=void 0),e.plugins||(e.plugins=[]),e.plugins=e.plugins.map((t=>{const n=new URL(t.url,i?window.location.origin:e.sourceUrl);return{url:n}})),e);i(2801);var te=i(6482);class ie{constructor(e){this._assetLink=e,this._store=e._store,this._vm=new n.Z({data:{plugins:[]}})}get vm(){return this._vm}async boot(){}async loadPlugin(e,t){const s=t||{},r=performance.now();let o;try{const t=await this._fetchPlugin(e,s),a=await fetch(t).then((e=>e.text()));if(e.pathname.endsWith("alink.js")){const t=`${a}\n//# sourceURL=asset-link-plugin:./${encodeURIComponent(e)}\n`,i="data:application/javascript;base64,"+btoa(t),n=(await import(i)).default;o=new n}else if(e.pathname.endsWith("alink.vue")){const s=new URL(e.toString());s.search="";const r=await i.e(244).then(i.bind(i,1244)),a={},l={};Object.entries(r).forEach((([e,t])=>{Object.prototype.hasOwnProperty.call(t,"component")?a[e]=t:["bind","inserted","update","componentUpdated","unbind"].find((e=>Object.prototype.hasOwnProperty.call(t,e)))&&(l[e]=t)}));let c=await fetch(t).then((e=>e.text()));const u=await i.e(725).then(i.t.bind(i,725,23)),d=new Set,h=new Set,g=u.parseComponent(c);if(g.errors.length>0)throw new Error(`Could not parse component plugin: ${g.errors.join("\n")}`);if(g.template){if(g.template.src)throw new Error("External component template content is not supported.");u.compile(g.template.content,{modules:[{postTransformNode:e=>{"directives"in e&&e.directives.forEach((({name:e})=>h.add(e))),d.add(e.tag)}}]})}const p=Array.from(d).map((e=>[le(e),oe(re(e))])).filter((([e,t])=>e.startsWith("v-")&&Object.prototype.hasOwnProperty.call(a,t))).map((([e,t])=>[t,a[t]])),f=Array.from(h).map((e=>oe(re(e)))).filter((e=>Object.prototype.hasOwnProperty.call(l,e))).map((e=>[e,l[e]]));this.moduleCache||(this.moduleCache=Object.assign(Object.create(null),{vue:n.Z,"vuetify/lib":r,"vue-codemirror":Promise.all([i.e(631),i.e(55)]).then(i.t.bind(i,5055,23)),"codemirror/mode/javascript/javascript.js":Promise.all([i.e(631),i.e(876)]).then(i.t.bind(i,6876,23)),"codemirror/mode/vue/vue.js":Promise.all([i.e(631),i.e(876),i.e(426)]).then(i.t.bind(i,2426,23)),"codemirror/lib/codemirror.css":i.e(989).then(i.bind(i,4989)),"codemirror/theme/base16-dark.css":i.e(903).then(i.bind(i,3903))}));const m={moduleCache:this.moduleCache,compiledCache:{set:(e,t)=>this._store.setItem(`asset-link-cached-compiled-plugin:${e}`,t),get:e=>this._store.getItem(`asset-link-cached-compiled-plugin:${e}`)},async getFile(e){if(e===s)return c;throw new Error(`Secondary imports are not supported. url=${e}`)},addStyle(){}};o=await(0,te.$y)(s,m),o.name||(o.name=`unnamed-sfc-plugin-${(0,T.Z)()}`),p.length&&!o.components&&(o.components={}),p.filter((e=>!o.components[e[0]])).forEach((e=>o.components[e[0]]=e[1])),f.length&&!o.directives&&(o.directives={}),f.filter((e=>!o.directives[e[0]])).forEach((e=>o.directives[e[0]]=e[1])),n.Z.component(o.name,o)}else o={};o.pluginUrl=e,o.rawSource=a,this.registerPlugin(o)}catch(a){console.log(a),o={},o.pluginUrl=e,o.error=a,this.registerPlugin(o)}finally{const t=performance.now();console.log(`Loading plugin ${e} took ${t-r} milliseconds`)}}registerPlugin(e){if(e.definedRoutes={},e.definedSlots={},e.definedWidgetDecorators={},e.definedPluginIngestor=void 0,e.attributedErrors={},this.vm.plugins.push(e),"function"===typeof e.onLoad){const t=new ne(e,this.vm);e.onLoad(t,this._assetLink)}this.vm.plugins.forEach((t=>{t!==e&&t.definedPluginIngestor&&t.definedPluginIngestor.ingestorFn(e),t!==e&&e.definedPluginIngestor&&e.definedPluginIngestor.ingestorFn(t)}))}async unloadPlugin(e){const t=this.vm.plugins.findIndex((t=>t.pluginUrl.toString()===e.toString())),i=this.vm.plugins[t];"function"===typeof i.onUnload&&i.onUnload(this._assetLink),-1!==t&&this.vm.plugins.splice(t,1),this.vm.plugins.forEach((t=>{["definedRoutes","definedSlots","definedWidgetDecorators","attributedErrors"].forEach((i=>{t[i]&&delete t[i][e.toString()]}))}))}async reloadPlugin(e){await this.unloadPlugin(e),await this.loadPlugin(e,{skipCache:!0})}async _fetchPlugin(e,t){const i=t||{},n=i.skipCache||e.searchParams&&e.searchParams.get("skipCache"),s=`asset-link-cached-plugin-src:${e}`,r=await this._store.getItem(s),o=Q();if(!n&&r&&o-r.timestamp<900)return r.value;const a=await fetch(e);if(!a.ok)throw new Error(`HTTP Error ${a.status}: ${a.statusText}`);const l=await a.text(),c="data:application/javascript;base64,"+btoa(l);return await this._store.setItem(s,{key:s,timestamp:o,value:c}),c}}class ne{constructor(e,t,i){this._pluginInstance=e,this._vm=t,this._attributedTo=i||e}get thisPlugin(){return this._pluginInstance}defineRoute(e,t){const i={name:e},n={path(e){i.path=e},componentFn(e){i.componentFn=e}};t(n);const s=Object.entries({path:"string",componentFn:"function"}).filter((([e,t])=>typeof i[e]!==t));s.length?console.log(`Route '${e}' is invalid due to missing or mismatched types for fields: ${JSON.stringify(s)}`,i):(this._setAttributedDefinition("definedRoutes",e,i),this._vm.$emit("add-route",i))}defineSlot(e,t){const i={name:e},n={type(e){i.type=e},showIf(e){i.predicateFn=e},multiplexContext(e){i.contextMultiplexerFn=e},weight(e){i.weightFn=e},componentFn(e){i.componentFn=e}};t(n);let s=Object.entries({type:"string",predicateFn:"function",componentFn:"function"}).filter((([e,t])=>typeof i[e]!==t));if(["undefined","function"].includes(typeof i.contextMultiplexerFn)||s.push(["contextMultiplexerFn","function?"]),["undefined","function","number"].includes(typeof i.weightFn)||s.push(["weightFn","(function|number)?"]),s.length)return void console.log(`Slot '${e}' is invalid due to missing or mismatched types for fields: ${JSON.stringify(s)}`,i);const r=i.predicateFn;i.predicateFn=e=>e.type===i.type&&r(e);const o=i.weightFn;void 0===o?i.weightFn=()=>100:"number"===typeof o&&(i.weightFn=()=>o),this._setAttributedDefinition("definedSlots",e,i)}defineWidgetDecorator(e,t){const i={name:e},n={targetWidgetName(e){i.targetWidgetName=e},appliesIf(e){i.predicateFn=e},weight(e){i.weightFn=e},componentFn(e){i.componentFn=e}};t(n);const s=Object.entries({targetWidgetName:"string",predicateFn:"function",componentFn:"function"}).filter((([e,t])=>typeof i[e]!==t));if(["undefined","function","number"].includes(typeof i.weightFn)||s.push(["weightFn","(function|number)?"]),s.length)return void console.log(`Widget decorator '${e}' is invalid due to missing or mismatched types for fields: ${JSON.stringify(s)}`,i);const r=i.predicateFn;i.predicateFn=e=>e.widgetName===i.targetWidgetName&&r(e);const o=i.weightFn;void 0===o?i.weightFn=()=>100:"number"===typeof o&&(i.weightFn=()=>o),this._setAttributedDefinition("definedWidgetDecorators",e,i)}definePluginIngestor(e){if(this._pluginInstance!==this._attributedTo)throw new Error("Plugin ingestors cannot be attributed to other plugins.");if(this._pluginInstance.definedPluginIngestor)throw new Error("Plugin ingestor already defined. Plugins cannot define multiple plugin ingestors.");const t={},i={onEveryPlugin(e){t.ingestorFn=e}};e(i);const n=Object.entries({ingestorFn:"function"}).filter((([e,i])=>typeof t[e]!==i));n.length?console.log(`Plugin ingestor is invalid due to missing or mismatched types for fields: ${JSON.stringify(n)}`,t):this._pluginInstance.definedPluginIngestor=t}onBehalfOf(e,t){if(this._pluginInstance!==this._attributedTo)throw new Error("Plugins may only act on behalf of eachother directly - e.g. onBehalfOf blocks cannot be nested.");const i=new ne(this._pluginInstance,this._vm,e);t(i)}recordError(e){this._pluginInstance.attributedErrors[this._attributedTo.pluginUrl.toString()]||(this._pluginInstance.attributedErrors[this._attributedTo.pluginUrl.toString()]=[]),this._pluginInstance.attributedErrors[this._attributedTo.pluginUrl.toString()].push(e)}_setAttributedDefinition(e,t,i){this._pluginInstance[e][this._attributedTo.pluginUrl.toString()]||(this._pluginInstance[e][this._attributedTo.pluginUrl.toString()]={}),this._pluginInstance[e][this._attributedTo.pluginUrl.toString()][t]=i}}const se=/-(\w)/g,re=e=>e.replace(se,((e,t)=>t?t.toUpperCase():"")),oe=e=>e.charAt(0).toUpperCase()+e.slice(1),ae=/\B([A-Z])/g,le=e=>e.replace(ae,"-$1").toLowerCase(),ce=(e,t)=>k()(e,t).then((e=>e.json()));class ue{constructor(e){this._app=e,this._viewModel=new n.Z({data:{booted:!1,bootProgress:0,bootText:"Starting",connectionStatus:new q,pendingUpdates:[],messages:[]}}),this._booted=new Promise((e=>{this._viewModel.$once("booted",(()=>{this._viewModel.booted=!0,e(!0)}))})),this._store=L().createInstance({name:"asset-link",storeName:"data"}),this._cores={},this._cores.pluginLists=new J(this),this._cores.pluginLoader=new ie(this),this._memory=void 0,this._remote=void 0,this._ui=new F(e),this._util=new U}get app(){return this._app}get viewModel(){return this._viewModel}get ui(){return this._ui}get util(){return this._util}get cores(){return this._cores}get entitySource(){return this._memory}get remoteEntitySource(){return this._remote}get plugins(){return this._cores.pluginLoader.vm.plugins}get booted(){return this._booted}async boot(){this.viewModel.bootText="Initializing storage",await this._store.ready(),this._cores.pluginLists.eventBus.$on("add-plugin",(async e=>{await this._cores.pluginLoader.loadPlugin(e)})),this._cores.pluginLists.eventBus.$on("remove-plugin",(async e=>{await this._cores.pluginLoader.unloadPlugin(e)})),this._cores.pluginLoader.vm.$on("add-route",(e=>{"function"===typeof this.app.addRoute&&this.app.addRoute(e)})),this._cores.pluginLoader.vm.$on("remove-route",(e=>{"function"===typeof this.app.removeRoute&&this.app.removeRoute(e)})),window.addEventListener("asset-link-plugin-changed",(async e=>{await this._cores.pluginLoader.reloadPlugin(new URL(e.detail.pluginUrl))})),await this._cores.pluginLoader.boot(),await this._cores.pluginLists.boot(),this.viewModel.bootText="Loading models...",this._models=await this._loadModels(),r.qZ.fetch=this._csrfAwareFetch.bind(this),this._schema=new l.DS({models:this._models});const e=new o.yt({namespace:"asset-link-orbitjs-bucket"});this._memory=new c.O5({schema:this._schema,cacheSettings:{queryOperators:_}}),this._remote=new p({schema:this._schema,name:"remote",host:(0,O.Z)("/api"),defaultFetchSettings:{timeout:1e4},bucket:e,requestQueueSettings:{autoProcess:this.viewModel.connectionStatus.isOnline||!1}});const t=()=>{this.viewModel.pendingUpdates=this._remote.requestQueue.entries.filter((e=>"update"===e.type))};this._remote.requestQueue.reified.then(t),this._remote.requestQueue.on("change",t),this._backup=new a.T6({schema:this._schema,name:"backup",namespace:"asset-link-orbitjs-entities",defaultTransformOptions:{useBuffer:!0}}),this._coordinator=new s.m1({sources:[this._memory,this._remote,this._backup]}),this._remoteQueryStrategy=new s.Q2({name:"remoteRequestStrategy",source:"memory",on:"beforeQuery",target:"remote",action:"query",blocking:!0}),this.viewModel.connectionStatus.isOnline&&this._coordinator.addStrategy(this._remoteQueryStrategy),this._coordinator.addStrategy(new s.Q2({source:"memory",on:"beforeUpdate",target:"remote",action:"update",blocking:!1})),this._coordinator.addStrategy(new s.xv({source:"remote",target:"memory",blocking:!1})),this._coordinator.addStrategy(new s.xv({source:"memory",target:"backup",blocking:!0}));const i=await this._backup.query((e=>e.findRecords()));return await this._memory.sync((e=>i.map((t=>e.addRecord(t))))),await this._coordinator.activate(),this.viewModel.bootProgress=100,this._memory.on("update",(e=>{console.log("_memory::update",e),"updateRecord"===e.operations.op&&e.operations.record.type.startsWith("asset--")&&this.viewModel.$emit("changed:asset",e.operations.record.type,e.operations.record.id)})),this.viewModel.connectionStatus.$watch("isOnline",(async e=>{this._remote.requestQueue.autoProcess=e,e&&!this._remote.requestQueue.empty&&this._remote.requestQueue.process(),await this._coordinator.deactivate(),e?this._coordinator.strategies.includes(this._remoteQueryStrategy)||this._coordinator.addStrategy(this._remoteQueryStrategy):this._coordinator.strategies.includes(this._remoteQueryStrategy)&&this._coordinator.removeStrategy(this._remoteQueryStrategy.name),await this._coordinator.activate()})),this.viewModel.$emit("booted"),this.viewModel.connectionStatus.isOnline&&this._precache(),!0}async getEntityModel(e){return await this._booted,this._models[e]}async _precache(){const e=window.location.href.match(/https?:\/\/.*\/asset\/(\d+)/);if(e&&e.length>=2){const t=await this.resolveAsset(e[1]);console.log("thisAsset=",t)}const t=Q(),i="asset-link-last-precache-time",n=await this._store.getItem(i);if(n&&t-n<900)return void console.log("Skipping Asset Link precaching because it was done recently...");const s=(await this.getAssetTypes()).map((e=>e.attributes.drupal_internal__id));await this._memory.query((e=>s.map((t=>e.findRecords(`asset--${t}`).sort("-changed").page({offset:0,limit:100}))))),await this._store.setItem(i,t)}async getAssetTypes(){const e=async e=>await e.query((e=>e.findRecords("asset_type--asset_type").sort("drupal_internal__id"))),t=await e(this._memory.cache);return t.length?t:await e(this._memory)}async resolveAsset(e){await this._booted;const t=(await this.getAssetTypes()).map((e=>e.attributes.drupal_internal__id)),i=/^-?\d+$/.test(e);let n={attribute:"id",value:e};i&&(n={attribute:"drupal_internal__id",value:parseInt(e)});const s=async e=>{const i=await e.query((e=>t.map((t=>e.findRecords(`asset--${t}`).filter(n).sort("drupal_internal__id"))))),s=i.flatMap((e=>e));return s.find((e=>e))},r=await s(this._memory.cache);return r||await s(this._memory)}searchAssets(e,t){console.log("searchAssets:",JSON.stringify(e),t);const i=this.plugins.filter((e=>"function"===typeof e.searchAssets)),n=[];for(let r=0;r<i.length;r+=1){const s=i[r],o=s.searchAssets(this,e,t);void 0!==o&&n.push(o)}async function*s(){console.log("coiterateSearchCursors: searchResultCursors =",n);const e=n.map((e=>new z(e)));while(e.length>0){let t,i;console.log("coiterateSearchCursors: peekableSearchResultCursors.length =",e.length,e);for(let s=0;s<e.length;s+=1){const n=e[s],r=await n.peek();void 0!==r.value&&((void 0===t||r.value.weight<(await t.peek()).value.weight)&&(t=n,i=r.done?s:void 0))}if(void 0===t)return;const n=await t.next();n.value&&(yield n.value),void 0!==i&&e.splice(i,1)}}return s()}getSlots(e){return this.getPluginDefinedComponents("definedSlots",e)}getWidgetDecorators(e){return this.getPluginDefinedComponents("definedWidgetDecorators",e)}getPluginDefinedComponents(e,t){const i=(e,t)=>e.weight<t.weight?-1:e.weight>t.weight?1:e.id<t.id?-1:e.id>t.id?1:0,n=t=>Object.values(t[e]||{}).flatMap((e=>Object.values(e)));return this.plugins.flatMap((e=>n(e))).filter((e=>e.predicateFn(t))).flatMap((e=>{let i=[t];return"function"===typeof e.contextMultiplexerFn&&(i=e.contextMultiplexerFn(t)),i.map(((t,n)=>({id:1===i.length?e.id:e.id+"."+n,componentFn:(i,n,s)=>e.componentFn(i,n,t,s),weight:e.weightFn(t)})))})).sort(i)}async _csrfAwareFetch(e,t){const i=t||{};i.method||(i.method="GET");const n=new URL(e,window.location.origin+window.assetLinkDrupalBasePath),s=n.host===window.location.host&&n.pathname.startsWith(window.assetLinkDrupalBasePath),r=!["HEAD","GET","OPTIONS","TRACE"].includes(i.method.toUpperCase()),o=s&&r;try{if(o){const e=await this.viewModel.connectionStatus.fetch((0,O.Z)("/session/token"));console.log("tokenResponse:",e);const t=await e.text();i.headers||(i.headers={}),i.headers["X-CSRF-Token"]=t}return await this.viewModel.connectionStatus.fetch(e,i)}catch(a){if(console.log("Error in _csrfAwareFetch",typeof a,a),"Network request failed"===a.message)return new Response(null,{status:503,statusText:"Service unavailable due to network error"});throw a}}async _loadModels(){const e="asset-link-cached-entity-models",t=await this._store.getItem(e);if(t)return t.value;const i=await this._loadModelsFromServer(),n=Q();return await this._store.setItem(e,{key:e,timestamp:n,value:i}),i}async _loadModelsFromServer(){this.viewModel.bootText="Loading server schema";const e=await ce((0,O.Z)("/api/schema")),t=e.allOf.flatMap((e=>e.links||[])),i={};return await Promise.all(t.map((async e=>{const n=await ce(e.targetSchema),s=await ce(n.definitions.data.items.$ref),r=s.definitions.type["const"];i[r]={attributes:Object.fromEntries(Object.entries(s.definitions.attributes.properties).map((([e,t])=>("integer"===t.type&&(t.type="number"),"third_party_settings"===e&&(t.type="object"),[e,t])))),relationships:s.definitions?.relationships?.properties||{}},this.viewModel.bootProgress=(Object.keys(i).length/t.length*100).toFixed(1)}))),i}}},7441:function(e,t,i){function n(e){return new URL(e,window.location.origin+window.assetLinkDrupalBasePath)}i.d(t,{Z:function(){return n}})},8787:function(e,t,i){var n=i(538),s=i(3428);n.Z.use(s.Z),t["Z"]=new s.Z({})},5597:function(e,t,i){var n=i(5205);(0,n.z)("/__THIS_GETS_REPLACED_AT_RUNTIME_BY_THE_DRUPAL_CONTROLLER__/service-worker.js",{ready(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered(){console.log("Service worker has been registered.")},cached(){console.log("Content has been cached for offline use.")},updatefound(){console.log("New content is downloading.")},updated(){console.log("New content is available; please refresh.")},offline(){console.log("No internet connection found. App is running in offline mode.")},error(e){console.error("Error during service worker registration:",e)}})}}]);
//# sourceMappingURL=chunk-common.js.map