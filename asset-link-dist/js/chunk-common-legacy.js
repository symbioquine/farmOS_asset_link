"use strict";(self["webpackChunkalinkjs"]=self["webpackChunkalinkjs"]||[]).push([[64],{7251:function(e,t,n){n.d(t,{Z:function(){return be}});var r=n(5200),i=n(9726),a=n(6198),s=n(6133),u=n(2751),o=n(4731),c=n(8508),l=(n(5666),n(1539),n(8783),n(3948),n(285),n(1637),n(7327),n(1249),n(6755),n(6699),n(2023),n(8309),n(4916),n(4723),n(2707),n(7601),n(6535),n(9244),n(9826),n(8862),n(561),n(2479),n(8559),n(9720),n(6977),n(7941),n(538)),p=n(1833),f=n(407),h=n(3864),d=n(9849),g=n(4634),m=n(8898),v=n(3796),w=n(9418),_=n(9161),k=(n(5306),n(3396)),y=n(5480),x=(n(4747),n(9600),n(1703),n(7132)),b=function(e){(0,w.Z)(n,e);var t=(0,_.Z)(n);function n(e){return(0,s.Z)(this,n),t.call(this,e)}return(0,u.Z)(n,[{key:"buildFilterParam",value:function(e){var t=this,n=[];return e.forEach((function(e,r){if("attribute"===e.kind&&"equal"===e.op){var i=e,a=t.serializeAttributeAsParam(void 0,i.attribute);n.push((0,v.Z)({},a,i.value))}else if("attribute"===e.kind){var s=e,u=t.serializeAttributeAsParam(void 0,s.attribute);n.push((0,v.Z)({},"client-"+u+"-"+r,{path:u,operator:s.op,value:s.value}))}else if("relatedRecord"===e.kind){var o,c=e;if(Array.isArray(c.record))n.push((0,v.Z)({},c.relation,c.record.map((function(e){return e.id})).join(",")));else n.push((0,v.Z)({},c.relation,null===c||void 0===c||null===(o=c.record)||void 0===o?void 0:o.id))}else{if("relatedRecords"!==e.kind)throw new x.gT("Filter operation ".concat(e.op," not recognized for JSONAPISource."));if("equal"!==e.op)throw new Error('Operation "'.concat(e.op,'" is not supported in JSONAPI for relatedRecords filtering'));var l=e;n.push((0,v.Z)({},l.relation,l.records.map((function(e){return e.id})).join(",")))}})),n}},{key:"serializeAttributeAsParam",value:function(e,t){if(this.serializer)return this.serializer.resourceAttribute(e,t);var n=this.serializerFor(k.pi.ResourceFieldParam);return n.serialize(t,{type:e})}}]),n}(k.$H),R=function(e){(0,w.Z)(n,e);var t=(0,_.Z)(n);function n(e){(0,s.Z)(this,n);var r=Object.assign({},e.defaultFetchSettings||{},{headers:{Accept:"application/vnd.api+json","Content-Type":"application/vnd.api+json"}});return t.call(this,Object.assign({},e,{defaultFetchSettings:r,serializerSettingsFor:(0,y.yk)({sharedSettings:{inflectors:{drupal:(0,y.PH)({},(function(e){return e.replace("--","/")}))}},settingsByType:(0,v.Z)({},k.pi.ResourceTypePath,{serializationOptions:{inflectors:["drupal"]}})}),URLBuilderClass:b}))}return(0,u.Z)(n)}(k.ZP),Z=n(8932),P=(n(3123),n(2222),n(7852),n(1532),n(7042),n(6051)),L=n(793),S={findRecord:P.CN.findRecord,findRelatedRecord:P.CN.findRelatedRecord,findRecords:function(e,t,n){var r=t,i=e.getRecordsSync(r.records||r.type);return r.filter&&(i=T(i,r.filter)),r.sort&&(i=O(i,r.sort)),r.page&&(i=E(i,r.page)),i},findRelatedRecords:function(e,t,n){var r=t,i=r.record,a=r.relationship,s=e.getRelatedRecordsSync(i,a);if(!s||0===s.length){if(!e.getRecordSync(i)){if(null!==n&&void 0!==n&&n.raiseNotFoundExceptions)throw new g.dR(i.type,i.id);return}return[]}var u=e.getRecordsSync(s);return r.filter&&(u=T(u,r.filter)),r.sort&&(u=O(u,r.sort)),r.page&&(u=E(u,r.page)),u}};function T(e,t){return e.filter((function(e){for(var n=0,r=t.length;n<r;n++)if(!I(e,t[n]))return!1;return!0}))}function I(e,t){if("attribute"===t.kind){var n=t.attribute.split("."),r=(0,L.In)(e,["attributes"].concat((0,Z.Z)(n))),i=t.value;switch(t.op){case"equal":case"=":return"string"===typeof r?r.toLowerCase()===i.toLowerCase():r===i;case"<>":return"string"===typeof r?r.toLowerCase()!==i.toLowerCase():r!==i;case">":return r>i;case">=":return r>=i;case"<":return r<i;case"<=":return r<=i;case"STARTS_WITH":return"string"===typeof r&&r.toLowerCase().startsWith(i.toLowerCase());case"CONTAINS":return"string"===typeof r&&r.toLowerCase().includes(i.toLowerCase());case"ENDS_WITH":return"string"===typeof r&&r.toLowerCase().endsWith(i.toLowerCase());case"IN":case"NOT IN":case"BETWEEN":case"NOT BETWEEN":throw new x.gT("Filter operation ".concat(t.op," is not yet implemented for Store."));case"IS NULL":return void 0===r||null===r;case"IS NOT NULL":return void 0!==r&&null!==r;default:throw new x.gT("Filter operation ".concat(t.op," not recognized for Store."))}}return P.CN.applyFilter(e,t)}function O(e,t){var n=new Map;e.forEach((function(e){n.set(e,t.map((function(t){if("attribute"===t.kind){var n=t.attribute.split(".");return(0,L.In)(e,["attributes"].concat((0,Z.Z)(n)))}throw new x.gT("Sort specifier ${sortSpecifier.kind} not recognized for Store.")})))}));var r=t.map((function(e){return"descending"===e.order?-1:1}));return e.sort((function(e,i){for(var a=n.get(e),s=n.get(i),u=0;u<t.length;u++){if(a[u]<s[u])return-r[u];if(a[u]>s[u])return r[u];if((0,L.Wi)(a[u])&&!(0,L.Wi)(s[u]))return r[u];if((0,L.Wi)(s[u])&&!(0,L.Wi)(a[u]))return-r[u]}return 0}))}function E(e,t){if(void 0!==t.limit){var n=void 0===t.offset?0:t.offset,r=t.limit;return e.slice(n,n+r)}throw new x.gT("Pagination options not recognized for Store. Please specify `offset` and `limit`.")}var C=n(1365),F=n.n(C),A=n(4098),N=n.n(A),$=n(4367),j=n(7056),M=n(4462),U=n(6619),W=n(7068),B=n(5934),D=function(){function e(t){(0,s.Z)(this,e),this._app=t}return(0,u.Z)(e,[{key:"c",get:function(){return{VBtn:j.Z,VListItem:M.Z,VListItemTitle:U.V9}}},{key:"dialog",get:function(){var e=this;return{confirm:function(){var t=(0,a.Z)(regeneratorRuntime.mark((function t(n){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e._app.$dialog.confirm({text:n,title:"Confirmation"});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));function n(e){return t.apply(this,arguments)}return n}(),promptText:function(){var t=(0,a.Z)(regeneratorRuntime.mark((function t(n){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e._app.$dialog.prompt({text:n,title:"Input"});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));function n(e){return t.apply(this,arguments)}return n}(),custom:function(){var t=(0,a.Z)(regeneratorRuntime.mark((function t(n,r){var i,a,s;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return i=(0,B.Z)(),a=new l.Z({}),t.next=4,new Promise((function(t){a.$on("submit",t),e._app.dialogs.push({id:i,context:a,componentFn:function(e,i){return i(W.Z,{props:{value:!0,fullscreen:!0},on:{input:function(){return t(void 0)}}},[i(n,(0,$.Z)({ref:"dialogComponent"},r))])}})}));case 4:return s=t.sent,e._app.dialogs=e._app.dialogs.filter((function(e){return e.id!==i})),t.abrupt("return",s);case 7:case"end":return t.stop()}}),t)})));function n(e,n){return t.apply(this,arguments)}return n}()}}}]),e}(),V=n(4036),q=n(7441),z=n(5396),Q=n.n(z),K=n(901),H=n.n(K),J=function(){function e(){(0,s.Z)(this,e)}return(0,u.Z)(e,[{key:"formatRFC3339",get:function(){return V.Z}},{key:"createDrupalUrl",get:function(){return q.Z}},{key:"geohash",get:function(){return Q()}},{key:"haversine",get:function(){return H()}},{key:"summarizeAssetNames",value:function(e){return e.length<=3?e.map((function(e){return e.attributes.name})).join(", "):"".concat(e[0].attributes.name," (+").concat(e.length-1," more)")}}]),e}(),G=n(4752),X=n.n(G),Y=l.Z.extend({props:{fetcherDelegate:{type:Object,default:function(){return{fetch:N()}}}},data:function(){return{$_running:!1,$_barrier:new ne,hasNetworkConnection:window.navigator.onLine,canReachFarmOS:void 0,isLoggedIn:void 0}},created:function(){var e=this;window.addEventListener("offline",(function(){e.hasNetworkConnection=!1,e.canReachFarmOS=!1})),window.addEventListener("online",(function(){e.hasNetworkConnection=!0,e.$data.$_barrier.release()})),window.navigator&&window.navigator.connection&&window.navigator.connection.addEventListener("change",(function(){return e.$data.$_barrier.release()})),this.$_mainLoop()},computed:{isOnline:function(){return this.canReachFarmOS&&this.isLoggedIn}},beforeDestroy:function(){this.$data.$_running=!1,this.$data.$_barrier.release()},methods:{fetch:function(e,t){var n=this;return(0,a.Z)(regeneratorRuntime.mark((function r(){var i,a,s,u;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return i=t||{},i.method||(i.method="GET"),a=new URL(e,window.location.origin+window.assetLinkDrupalBasePath),s=a.host===window.location.host&&a.pathname.startsWith(window.assetLinkDrupalBasePath),r.prev=4,r.next=7,n.fetcherDelegate.fetch(e,i);case 7:return u=r.sent,s&&403===u.status&&n.$data.$_barrier.release(),r.abrupt("return",u);case 12:throw r.prev=12,r.t0=r["catch"](4),s&&n.$data.$_barrier.release(),r.t0;case 16:case"end":return r.stop()}}),r,null,[[4,12]])})))()},$_mainLoop:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.$data.$_running=!0,n=X()((function(){return e.$_checkConnectionStatus()}),1e3);case 2:if(!e.$data.$_running){t.next=9;break}return t.next=5,n();case 5:return t.next=7,e.$data.$_barrier.arrive(6e4);case 7:t.next=2;break;case 9:case"end":return t.stop()}}),t)})))()},$_checkConnectionStatus:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var n,r,i,a,s,u,o,c,l,p;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasNetworkConnection){t.next=2;break}return t.abrupt("return");case 2:return n=(0,q.Z)("api?cacheBust=".concat(te())),t.prev=3,t.next=6,N()(n,{credentials:"same-origin",cache:"no-cache"});case 6:if(o=t.sent,200===o.status){t.next=10;break}return e.canReachFarmOS=!1,t.abrupt("return");case 10:return t.next=12,o.json();case 12:if(c=t.sent,l=null===(r=c.meta)||void 0===r||null===(i=r.farm)||void 0===i?void 0:i.version,"2.x"===l){t.next=17;break}return e.canReachFarmOS=!1,t.abrupt("return");case 17:e.canReachFarmOS=!0,p=null===(a=c.meta)||void 0===a||null===(s=a.links)||void 0===s||null===(u=s.me)||void 0===u?void 0:u.href,e.isLoggedIn=void 0!==p,t.next=25;break;case 22:t.prev=22,t.t0=t["catch"](3),e.canReachFarmOS=!1;case 25:case"end":return t.stop()}}),t,null,[[3,22]])})))()}}});function ee(e){return new Promise((function(t){return setTimeout(t,e)}))}function te(){return parseInt((new Date).getTime()/1e3)}var ne=function(){function e(){(0,s.Z)(this,e),this.waiting=[]}return(0,u.Z)(e,[{key:"arrive",value:function(e){var t=this;return Promise.race([ee(e),new Promise((function(e){return t.waiting.push(e)}))])}},{key:"release",value:function(){var e=this.waiting.splice(0);e.forEach((function(e){return e()}))}}]),e}(),re=Y,ie=function(){function e(t){(0,s.Z)(this,e),this._delegate=t,this._next_iteration_result=void 0}return(0,u.Z)(e,[{key:"next",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(void 0===this._next_iteration_result){e.next=4;break}return t=this._next_iteration_result,this._next_iteration_result=void 0,e.abrupt("return",t);case 4:return e.next=6,this._delegate.next();case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"peek",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(void 0!==this._next_iteration_result){e.next=4;break}return e.next=3,this._delegate.next();case 3:this._next_iteration_result=e.sent;case 4:return e.abrupt("return",this._next_iteration_result);case 5:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()}]),e}();n(4553),n(9714),n(6314);function ae(){return parseInt((new Date).getTime()/1e3)}var se=function(){function e(){(0,s.Z)(this,e),this._handlersByEventName={}}return(0,u.Z)(e,[{key:"$on",value:function(e,t){Object.hasOwn(this._handlersByEventName,e)||(this._handlersByEventName[e]=[]),this._handlersByEventName[e].push(t)}},{key:"$emit",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,n){var r,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=this._handlersByEventName[t]||[],i=r.map((function(e){return e(n)})),e.abrupt("return",Promise.all(i).then((function(){return!0})));case 3:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()}]),e}(),ue=n(4261),oe=function(e){(0,w.Z)(n,e);var t=(0,_.Z)(n);function n(e,r){return(0,s.Z)(this,n),t.call(this,e,r)}return(0,u.Z)(n)}((0,ue.Z)(Error)),ce=function(){function e(t){(0,s.Z)(this,e),this._store=t._store,this._vm=new l.Z({data:{lists:[]}}),this._eventBus=new se,this._pluginReferenceTracker=new le(this._eventBus),this._defaultPluginList=new pe(t._store,(0,q.Z)("/alink/backend/default-plugins.repo.json"),this._pluginReferenceTracker,!0),this._localPluginList=new fe(t._store,this._pluginReferenceTracker),this._extraPluginLists=[],this._extraPluginListStoreKey="asset-link-extra-plugin-lists"}return(0,u.Z)(e,[{key:"vm",get:function(){return this._vm}},{key:"eventBus",get:function(){return this._eventBus}},{key:"boot",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n,r,i,a,s=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._getExtraPluginListUrls();case 2:t=e.sent,this._extraPluginLists=t.map((function(e){return new pe(s._store,e,s._pluginReferenceTracker,!1)})),n=0,r=[this._defaultPluginList,this._localPluginList].concat((0,Z.Z)(this._extraPluginLists));case 5:if(!(n<r.length)){e.next=14;break}return i=r[n],e.next=9,i.load();case 9:a=e.sent,this._updatePluginListViewInViewModel(a);case 11:n++,e.next=5;break;case 14:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"addPluginToLocalList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._localPluginList.addPlugin(t);case 2:n=e.sent,this._updatePluginListViewInViewModel(n);case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"removePluginFromLocalList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._localPluginList.removePlugin(t);case 2:n=e.sent,this._updatePluginListViewInViewModel(n);case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"addExtraPluginList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this._modifyAndWriteStoredExtraPluginListUrls((function(e){var n=e.findIndex((function(e){return e===t}));if(n>=0)return!1;e.push(t)})),n=this._extraPluginLists.findIndex((function(e){return e._url===t})),!(n>=0)){e.next=4;break}return e.abrupt("return");case 4:return r=new pe(this._store,t,this._pluginReferenceTracker,!1),this._extraPluginLists.push(r),e.next=8,r.load();case 8:i=e.sent,this._updatePluginListViewInViewModel(i);case 10:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"removeExtraPluginList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this._modifyAndWriteStoredExtraPluginListUrls((function(e){var n=e.findIndex((function(e){return e===t}));if(n<0)return!1;e.splice(n,1)})),n=this._extraPluginLists.findIndex((function(e){return e._url===t})),!(n<0)){e.next=4;break}return e.abrupt("return");case 4:return r=this._extraPluginLists.splice(n,1)[0],e.next=7,r.unload();case 7:this._removePluginListViewFromViewModel(t);case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"reloadPluginList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=[this._defaultPluginList,this._localPluginList].concat((0,Z.Z)(this._extraPluginLists)).find((function(e){return e._url===t})),n){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,n.reload();case 5:r=e.sent,this._updatePluginListViewInViewModel(r);case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_getExtraPluginListUrls",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._store.getItem(this._extraPluginListStoreKey);case 2:if(t=e.sent,!t){e.next=5;break}return e.abrupt("return",t.value.map((function(e){return new URL(e)})));case 5:return e.abrupt("return",[]);case 6:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_modifyAndWriteStoredExtraPluginListUrls",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._getExtraPluginListUrls();case 2:if(n=e.sent,r=!1!==t(n),!r){e.next=7;break}return e.next=7,this._store.setItem(this._extraPluginListStoreKey,{key:this._extraPluginListStoreKey,timestamp:ae(),value:n});case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_updatePluginListViewInViewModel",value:function(e){var t=this.vm,n=t.lists.findIndex((function(t){return t.sourceUrl===e.sourceUrl}));n>=0?t.lists.splice(n,1,e):t.lists.push(e)}},{key:"_removePluginListViewFromViewModel",value:function(e){var t=this.vm,n=t.lists.findIndex((function(t){return t.sourceUrl===e}));n>=0&&t.lists.splice(n,1)}}]),e}(),le=function(){function e(t){(0,s.Z)(this,e),this._eventBus=t,this._pluginReferences={}}return(0,u.Z)(e,[{key:"ackPluginReference",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,n){var r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(console.log("ackPluginReference",t.toString(),n.toString()),r=Object.hasOwn(this._pluginReferences,t.toString()),r||(this._pluginReferences[t.toString()]=[]),i=this._pluginReferences[t.toString()],a=i.indexOf(n.toString()),a<0&&i.push(n),r){e.next=9;break}return e.next=9,this._eventBus.$emit("add-plugin",t);case 9:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"freePluginReference",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,n){var r,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=this._pluginReferences[t.toString()],r){e.next=4;break}return console.log("freePluginReference unexpectedly found plugin missing from internal reference tracking",t.toString(),n.toString(),JSON.stringify(this._pluginReferences)),e.abrupt("return");case 4:if(i=r.indexOf(n.toString()),i>=0?r.splice(i,1):console.log("freePluginReference unexpectedly found plugin without expected reference",t.toString(),n.toString(),JSON.stringify(r)),!(r.length>0)){e.next=8;break}return e.abrupt("return");case 8:return e.next=10,this._eventBus.$emit("remove-plugin",t);case 10:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()}]),e}(),pe=function(){function e(t,n,r,i){(0,s.Z)(this,e),this._store=t,this._storeKey="asset-link-cached-plugin-list:".concat(n),this._url=n,this._pluginReferenceTracker=r,this._isDefault=i,this._latestPluginListView=void 0}return(0,u.Z)(e,[{key:"load",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.t0=he,e.next=3,this._getHttpPluginList(t);case 3:return e.t1=e.sent,e.t2=this._url,this._latestPluginListView=(0,e.t0)(e.t1,!1,e.t2),e.next=8,Promise.all(this._latestPluginListView.plugins.map((function(e){return n._pluginReferenceTracker.ackPluginReference(e.url,n._url)})));case 8:return e.abrupt("return",this._latestPluginListView);case 9:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"unload",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this._latestPluginListView){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Promise.all(this._latestPluginListView.plugins.map((function(e){return t._pluginReferenceTracker.freePluginReference(e.url,t._url)})));case 4:return e.next=6,this._store.removeItem(this._storeKey);case 6:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"reload",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.load(!0);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_getHttpPluginList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t){e.next=4;break}e.t0=void 0,e.next=7;break;case 4:return e.next=6,this._store.getItem(this._storeKey);case 6:e.t0=e.sent;case 7:if(n=e.t0,r=ae(),!(n&&r-n.timestamp<900)){e.next=11;break}return e.abrupt("return",n.value);case 11:return e.next=13,fetch(this._url);case 13:if(i=e.sent,console.log(i),403!==i.status){e.next=19;break}throw new oe("HTTP Error ".concat(i.status,": ").concat(i.statusText));case 19:if(i.ok){e.next=21;break}throw new Error("HTTP Error ".concat(i.status,": ").concat(i.statusText));case 21:return e.next=23,i.json();case 23:return a=e.sent,e.next=26,this._store.setItem(this._storeKey,{key:this._storeKey,timestamp:r,value:a});case 26:return e.abrupt("return",a);case 27:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}(),fe=function(){function e(t,n){(0,s.Z)(this,e),this._store=t,this._storeKey="local-plugin-list.repo.json",this._url=new URL("indexeddb://asset-link/data/local-plugin-list.repo.json",window.location.origin),this._pluginReferenceTracker=n}return(0,u.Z)(e,[{key:"load",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.t0=he,e.next=3,this._getLocalPluginList();case 3:return e.t1=e.sent,e.t2=this._url,t=(0,e.t0)(e.t1,!1,e.t2),e.next=8,Promise.all(t.plugins.map((function(e){return n._pluginReferenceTracker.ackPluginReference(e.url,n._url)})));case 8:return e.abrupt("return",t);case 9:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"reload",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.load();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"addPlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._modifyAndWriteStoredList((function(e){if(e.plugins.find((function(e){return e.url===t.toString()})))return!1;e.plugins.push({url:t.toString()})}));case 2:return n=e.sent,e.next=5,this._pluginReferenceTracker.ackPluginReference(t,this._url);case 5:return e.abrupt("return",he(n,!1,this._url));case 6:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"removePlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._modifyAndWriteStoredList((function(e){var n=e.plugins.findIndex((function(e){return e.url===t.toString()}));if(n<0)return!1;e.plugins.splice(n,1)}));case 2:return n=e.sent,e.next=5,this._pluginReferenceTracker.freePluginReference(t,this._url);case 5:return e.abrupt("return",he(n,!1,this._url));case 6:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_getLocalPluginList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._store.getItem(this._storeKey);case 2:if(t=e.sent,t){e.next=5;break}return e.abrupt("return",{plugins:[]});case 5:return e.abrupt("return",t.value);case 6:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_modifyAndWriteStoredList",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._getLocalPluginList();case 2:if(n=e.sent,r=!1!==t(n),!r){e.next=7;break}return e.next=7,this._store.setItem(this._storeKey,{key:this._storeKey,timestamp:ae(),value:n});case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}(),he=function(e,t,n){return e.isDefault=t,e.sourceUrl=n,e.error||(e.error=void 0),e.plugins||(e.plugins=[]),e.plugins=e.plugins.map((function(e){var t=new URL(e.url,window.location.origin);return{url:t}})),e},de=(n(4765),n(189),n(1038),n(7714),n(2801),n(1174),n(6482)),ge=function(){function e(t){(0,s.Z)(this,e),this._assetLink=t,this._store=t._store,this._vm=new l.Z({data:{plugins:[]}})}return(0,u.Z)(e,[{key:"vm",get:function(){return this._vm}},{key:"boot",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"loadPlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,i){var s,u,o,c,p,f,h,d,g,m,v,w,_,k,y,x,b,R,Z=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s=i||{},u=performance.now(),o=void 0,e.prev=3,e.next=6,this._fetchPlugin(t,s);case 6:if(c=e.sent,!t.pathname.endsWith("alink.js")){e.next=14;break}return e.next=10,import(c);case 10:p=e.sent.default,o=new p,e.next=54;break;case 14:if(!t.pathname.endsWith("alink.vue")){e.next=53;break}return f=new URL(t.toString()),f.search="",e.next=19,n.e(244).then(n.bind(n,1244));case 19:return h=e.sent,d={},g={},Object.entries(h).forEach((function(e){var t=(0,r.Z)(e,2),n=t[0],i=t[1];Object.prototype.hasOwnProperty.call(i,"component")?d[n]=i:["bind","inserted","update","componentUpdated","unbind"].find((function(e){return Object.prototype.hasOwnProperty.call(i,e)}))&&(g[n]=i)})),e.next=25,fetch(c).then((function(e){return e.text()}));case 25:return m=e.sent,e.next=28,n.e(725).then(n.t.bind(n,725,23));case 28:if(v=e.sent,w=new Set,_=new Set,k=v.parseComponent(m),!(k.errors.length>0)){e.next=34;break}throw new Error("Could not parse component plugin: ".concat(k.errors.join("\n")));case 34:if(!k.template){e.next=38;break}if(!k.template.src){e.next=37;break}throw new Error("External component template content is not supported.");case 37:v.compile(k.template.content,{modules:[{postTransformNode:function(e){"directives"in e&&e.directives.forEach((function(e){var t=e.name;return _.add(t)})),w.add(e.tag)}}]});case 38:return y=Array.from(w).map((function(e){return[ye(e),_e(we(e))]})).filter((function(e){var t=(0,r.Z)(e,2),n=t[0],i=t[1];return n.startsWith("v-")&&Object.prototype.hasOwnProperty.call(d,i)})).map((function(e){var t=(0,r.Z)(e,2),n=(t[0],t[1]);return[n,d[n]]})),x=Array.from(_).map((function(e){return _e(we(e))})).filter((function(e){return Object.prototype.hasOwnProperty.call(g,e)})).map((function(e){return[e,g[e]]})),this.moduleCache||(this.moduleCache=Object.assign(Object.create(null),{vue:l.Z,"vuetify/lib":h,"vue-codemirror":Promise.all([n.e(631),n.e(55)]).then(n.t.bind(n,5055,23)),"codemirror/mode/javascript/javascript.js":Promise.all([n.e(631),n.e(876)]).then(n.t.bind(n,6876,23)),"codemirror/mode/vue/vue.js":Promise.all([n.e(631),n.e(876),n.e(426)]).then(n.t.bind(n,2426,23)),"codemirror/lib/codemirror.css":n.e(989).then(n.bind(n,4989)),"codemirror/theme/base16-dark.css":n.e(903).then(n.bind(n,3903))})),b={moduleCache:this.moduleCache,compiledCache:{set:function(e,t){return Z._store.setItem("asset-link-cached-compiled-plugin:".concat(e),t)},get:function(e){return Z._store.getItem("asset-link-cached-compiled-plugin:".concat(e))}},getFile:function(e){return(0,a.Z)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e!==f){t.next=4;break}return t.abrupt("return",m);case 4:throw new Error("Secondary imports are not supported. url=".concat(e));case 5:case"end":return t.stop()}}),t)})))()},addStyle:function(){}},e.next=44,(0,de.$y)(f,b);case 44:o=e.sent,o.name||(o.name="unnamed-sfc-plugin-".concat((0,B.Z)())),y.length&&!o.components&&(o.components={}),y.filter((function(e){return!o.components[e[0]]})).forEach((function(e){return o.components[e[0]]=e[1]})),x.length&&!o.directives&&(o.directives={}),x.filter((function(e){return!o.directives[e[0]]})).forEach((function(e){return o.directives[e[0]]=e[1]})),l.Z.component(o.name,o),e.next=54;break;case 53:throw new Error("Cannot load plugin ".concat(t," with unsupported type. Path of url must end in '.alink.js' or '.alink.vue'"));case 54:o.pluginUrl=t,this.registerPlugin(o),e.next=65;break;case 58:e.prev=58,e.t0=e["catch"](3),console.log(e.t0),o={},o.pluginUrl=t,o.error=e.t0,this.registerPlugin(o);case 65:return e.prev=65,R=performance.now(),console.log("Loading plugin ".concat(t," took ").concat(R-u," milliseconds")),e.finish(65);case 69:case"end":return e.stop()}}),e,this,[[3,58,65,69]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"registerPlugin",value:function(e){if(e.definedRoutes={},e.definedSlots={},e.definedWidgetDecorators={},this.vm.plugins.push(e),"function"===typeof e.onLoad){var t=new me(e,this.vm);e.onLoad(t,this._assetLink)}}},{key:"unloadPlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:n=this.vm.plugins.findIndex((function(e){return e.pluginUrl.toString()===t.toString()})),-1!==n&&this.vm.plugins.splice(n,1);case 2:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"reloadPlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.unloadPlugin(t);case 2:return e.next=4,this.loadPlugin(t,{skipCache:!0});case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_fetchPlugin",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,n){var r,i,a,s,u,o,c,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=n||{},i=r.skipCache||t.searchParams&&t.searchParams.get("skipCache"),a="asset-link-cached-plugin-src:".concat(t),e.next=5,this._store.getItem(a);case 5:if(s=e.sent,u=ae(),!(!i&&s&&u-s.timestamp<900)){e.next=9;break}return e.abrupt("return",s.value);case 9:return e.next=11,fetch(t).then((function(e){return e.text()}));case 11:return o=e.sent,c="".concat(o,"\n//# sourceURL=asset-link-plugin:./").concat(encodeURIComponent(t),"\n"),l="data:application/javascript;base64,"+btoa(c),e.next=16,this._store.setItem(a,{key:a,timestamp:u,value:l});case 16:return e.abrupt("return",l);case 17:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()}]),e}(),me=function(){function e(t,n){(0,s.Z)(this,e),this._pluginInstance=t,this._vm=n}return(0,u.Z)(e,[{key:"thisPlugin",get:function(){return this._pluginInstance}},{key:"defineRoute",value:function(e,t){var n={name:e},a={path:function(e){n.path=e},componentFn:function(e){n.componentFn=e}};t(a);var s=Object.entries({path:"string",componentFn:"function"}).filter((function(e){var t=(0,r.Z)(e,2),a=t[0],s=t[1];return(0,i.Z)(n[a])!==s}));s.length?console.log("Action '".concat(e,"' is invalid due to missing or mismatched types for fields: ").concat(JSON.stringify(s)),n):(this._pluginInstance.definedRoutes[e]=n,this._vm.$emit("add-route",n))}},{key:"defineSlot",value:function(e,t){var n={name:e},a={type:function(e){n.type=e},showIf:function(e){n.predicateFn=e},componentFn:function(e){n.componentFn=e}};t(a);var s=Object.entries({type:"string",predicateFn:"function",componentFn:"function"}).filter((function(e){var t=(0,r.Z)(e,2),a=t[0],s=t[1];return(0,i.Z)(n[a])!==s}));if(s.length)console.log("Slot '".concat(e,"' is invalid due to missing or mismatched types for fields: ").concat(JSON.stringify(s)),n);else{var u=n.predicateFn;n.predicateFn=function(e){return e.type===n.type&&u(e)},this._pluginInstance.definedSlots[e]=n}}},{key:"defineWidgetDecorator",value:function(e,t){var n={name:e},a={targetWidgetName:function(e){n.targetWidgetName=e},appliesIf:function(e){n.predicateFn=e},componentFn:function(e){n.componentFn=e}};t(a);var s=Object.entries({targetWidgetName:"string",predicateFn:"function",componentFn:"function"}).filter((function(e){var t=(0,r.Z)(e,2),a=t[0],s=t[1];return(0,i.Z)(n[a])!==s}));if(s.length)console.log("Widget decorator '".concat(e,"' is invalid due to missing or mismatched types for fields: ").concat(JSON.stringify(s)),n);else{var u=n.predicateFn;n.predicateFn=function(e){return e.widgetName===n.targetWidgetName&&u(e)},this._pluginInstance.definedWidgetDecorators[e]=n}}}]),e}(),ve=/-(\w)/g,we=function(e){return e.replace(ve,(function(e,t){return t?t.toUpperCase():""}))},_e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},ke=/\B([A-Z])/g,ye=function(e){return e.replace(ke,"-$1").toLowerCase()},xe=function(e,t){return N()(e,t).then((function(e){return e.json()}))},be=function(){function e(t){var n=this;(0,s.Z)(this,e),this._app=t,this._viewModel=new l.Z({data:{booted:!1,bootProgress:0,bootText:"Starting",connectionStatus:new re,pendingUpdates:[],messages:[]}}),this._booted=new Promise((function(e){n._viewModel.$once("booted",(function(){n._viewModel.booted=!0,e(!0)}))})),this._store=F().createInstance({name:"asset-link",storeName:"data"}),this._cores={},this._cores.pluginLists=new ce(this),this._cores.pluginLoader=new ge(this),this._memory=void 0,this._remote=void 0,this._ui=new D(t),this._util=new J}return(0,u.Z)(e,[{key:"app",get:function(){return this._app}},{key:"viewModel",get:function(){return this._viewModel}},{key:"ui",get:function(){return this._ui}},{key:"util",get:function(){return this._util}},{key:"cores",get:function(){return this._cores}},{key:"entitySource",get:function(){return this._memory}},{key:"remoteEntitySource",get:function(){return this._remote}},{key:"plugins",get:function(){return this._cores.pluginLoader.vm.plugins}},{key:"booted",get:function(){return this._booted}},{key:"boot",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n,r,i=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.viewModel.bootText="Initializing storage",e.next=3,this._store.ready();case 3:return this._cores.pluginLists.eventBus.$on("add-plugin",function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i._cores.pluginLoader.loadPlugin(t);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this._cores.pluginLists.eventBus.$on("remove-plugin",function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i._cores.pluginLoader.unloadPlugin(t);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this._cores.pluginLoader.vm.$on("add-route",(function(e){"function"===typeof i.app.addRoute&&i.app.addRoute(e)})),this._cores.pluginLoader.vm.$on("remove-route",(function(e){"function"===typeof i.app.removeRoute&&i.app.removeRoute(e)})),window.addEventListener("asset-link-plugin-changed",function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i._cores.pluginLoader.reloadPlugin(new URL(t.detail.pluginUrl));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=10,this._cores.pluginLoader.boot();case 10:return e.next=12,this._cores.pluginLists.boot();case 12:return this.viewModel.bootText="Loading models...",e.next=15,this._loadModels();case 15:return this._models=e.sent,f.qZ.fetch=this._csrfAwareFetch.bind(this),this._schema=new g.DS({models:this._models}),t=new h.yt({namespace:"asset-link-orbitjs-bucket"}),this._memory=new m.O5({schema:this._schema,cacheSettings:{queryOperators:S}}),this._remote=new R({schema:this._schema,name:"remote",host:(0,q.Z)("/api"),defaultFetchSettings:{timeout:1e4},bucket:t,requestQueueSettings:{autoProcess:this.viewModel.connectionStatus.isOnline||!1}}),n=function(){i.viewModel.pendingUpdates=i._remote.requestQueue.entries.filter((function(e){return"update"===e.type}))},this._remote.requestQueue.reified.then(n),this._remote.requestQueue.on("change",n),this._backup=new d.T6({schema:this._schema,name:"backup",namespace:"asset-link-orbitjs-entities",defaultTransformOptions:{useBuffer:!0}}),this._coordinator=new p.m1({sources:[this._memory,this._remote,this._backup]}),this._remoteQueryStrategy=new p.Q2({name:"remoteRequestStrategy",source:"memory",on:"beforeQuery",target:"remote",action:"query",blocking:!0}),this.viewModel.connectionStatus.isOnline&&this._coordinator.addStrategy(this._remoteQueryStrategy),this._coordinator.addStrategy(new p.Q2({source:"memory",on:"beforeUpdate",target:"remote",action:"update",blocking:!1})),this._coordinator.addStrategy(new p.xv({source:"remote",target:"memory",blocking:!1})),this._coordinator.addStrategy(new p.xv({source:"memory",target:"backup",blocking:!0})),e.next=33,this._backup.query((function(e){return e.findRecords()}));case 33:return r=e.sent,e.next=36,this._memory.sync((function(e){return r.map((function(t){return e.addRecord(t)}))}));case 36:return e.next=38,this._coordinator.activate();case 38:return this.viewModel.bootProgress=100,this._memory.on("update",(function(e){console.log("_memory::update",e),"updateRecord"===e.operations.op&&e.operations.record.type.startsWith("asset--")&&i.viewModel.$emit("changed:asset",e.operations.record.type,e.operations.record.id)})),this.viewModel.connectionStatus.$watch("isOnline",function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i._remote.requestQueue.autoProcess=t,t&&!i._remote.requestQueue.empty&&i._remote.requestQueue.process(),e.next=4,i._coordinator.deactivate();case 4:return t?i._coordinator.strategies.includes(i._remoteQueryStrategy)||i._coordinator.addStrategy(i._remoteQueryStrategy):i._coordinator.strategies.includes(i._remoteQueryStrategy)&&i._coordinator.removeStrategy(i._remoteQueryStrategy.name),e.next=7,i._coordinator.activate();case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.viewModel.$emit("booted"),this.viewModel.connectionStatus.isOnline&&this._precache(),e.abrupt("return",!0);case 44:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getEntityModel",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._booted;case 2:return e.abrupt("return",this._models[t]);case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_precache",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n,r,i,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t=window.location.href.match(/https?:\/\/.*\/asset\/(\d+)/),!(t&&t.length>=2)){e.next=6;break}return e.next=4,this.resolveAsset(t[1]);case 4:n=e.sent,console.log("thisAsset=",n);case 6:return r=ae(),i="asset-link-last-precache-time",e.next=10,this._store.getItem(i);case 10:if(a=e.sent,!(a&&r-a<900)){e.next=14;break}return console.log("Skipping Asset Link precaching because it was done recently..."),e.abrupt("return");case 14:return e.next=16,this.getAssetTypes();case 16:return s=e.sent.map((function(e){return e.attributes.drupal_internal__id})),e.next=19,this._memory.query((function(e){return s.map((function(t){return e.findRecords("asset--".concat(t)).sort("-changed").page({offset:0,limit:100})}))}));case 19:return e.next=21,this._store.setItem(i,r);case 21:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getAssetTypes",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.query((function(e){return e.findRecords("asset_type--asset_type").sort("drupal_internal__id")}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=3,t(this._memory.cache);case 3:if(n=e.sent,!n.length){e.next=6;break}return e.abrupt("return",n);case 6:return e.next=8,t(this._memory);case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"resolveAsset",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var n,r,i,s,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._booted;case 2:return e.next=4,this.getAssetTypes();case 4:return n=e.sent.map((function(e){return e.attributes.drupal_internal__id})),r=/^-?\d+$/.test(t),i={attribute:"id",value:t},r&&(i={attribute:"drupal_internal__id",value:parseInt(t)}),s=function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var r,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.query((function(e){return n.map((function(t){return e.findRecords("asset--".concat(t)).filter(i).sort("drupal_internal__id")}))}));case 2:return r=e.sent,a=r.flatMap((function(e){return e})),e.abrupt("return",a.find((function(e){return e})));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=11,s(this._memory.cache);case 11:if(u=e.sent,!u){e.next=14;break}return e.abrupt("return",u);case 14:return e.next=16,s(this._memory);case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"searchAssets",value:function(e,t){console.log("searchAssets:",JSON.stringify(e),t);for(var n=this.plugins.filter((function(e){return"function"===typeof e.searchAssets})),r=[],i=0;i<n.length;i+=1){var a=n[i],s=a.searchAssets(this,e,t);void 0!==s&&r.push(s)}function u(){return l.apply(this,arguments)}function l(){return l=(0,c.Z)(regeneratorRuntime.mark((function e(){var t,n,i,a,s,u,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:console.log("coiterateSearchCursors: searchResultCursors =",r),t=r.map((function(e){return new ie(e)}));case 2:if(!(t.length>0)){e.next=38;break}console.log("coiterateSearchCursors: peekableSearchResultCursors.length =",t.length,t),n=void 0,i=void 0,a=0;case 7:if(!(a<t.length)){e.next=27;break}return s=t[a],e.next=11,(0,o.Z)(s.peek());case 11:if(u=e.sent,void 0!==u.value){e.next=14;break}return e.abrupt("continue",24);case 14:if(e.t0=void 0===n,e.t0){e.next=21;break}return e.t1=u.value.weight,e.next=19,(0,o.Z)(n.peek());case 19:e.t2=e.sent.value.weight,e.t0=e.t1<e.t2;case 21:if(!e.t0){e.next=24;break}n=s,i=u.done?a:void 0;case 24:a+=1,e.next=7;break;case 27:if(void 0!==n){e.next=29;break}return e.abrupt("return");case 29:return e.next=31,(0,o.Z)(n.next());case 31:if(c=e.sent,!c.value){e.next=35;break}return e.next=35,c.value;case 35:void 0!==i&&t.splice(i,1),e.next=2;break;case 38:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}return u()}},{key:"getSlots",value:function(e){return this.getPluginDefinedComponents("definedSlots",e)}},{key:"getWidgetDecorators",value:function(e){return this.getPluginDefinedComponents("definedWidgetDecorators",e)}},{key:"getPluginDefinedComponents",value:function(e,t){var n=function(e,t){return e.weight<t.weight?-1:e.weight>t.weight?1:e.id<t.id?-1:e.id>t.id?1:0},r=function(t){return t[e]||{}};return this.plugins.flatMap((function(e){return Object.values(r(e))})).filter((function(e){return e.predicateFn(t)})).map((function(e){return{id:e.id,componentFn:function(n,r,i){return e.componentFn(n,r,t,i)},weight:e.weight||100}})).sort(n)}},{key:"_csrfAwareFetch",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t,n){var r,a,s,u,o,c,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=n||{},r.method||(r.method="GET"),a=new URL(t,window.location.origin+window.assetLinkDrupalBasePath),s=a.host===window.location.host&&a.pathname.startsWith(window.assetLinkDrupalBasePath),u=!["HEAD","GET","OPTIONS","TRACE"].includes(r.method.toUpperCase()),o=s&&u,e.prev=6,!o){e.next=17;break}return e.next=10,this.viewModel.connectionStatus.fetch((0,q.Z)("/session/token"));case 10:return c=e.sent,console.log("tokenResponse:",c),e.next=14,c.text();case 14:l=e.sent,r.headers||(r.headers={}),r.headers["X-CSRF-Token"]=l;case 17:return e.next=19,this.viewModel.connectionStatus.fetch(t,r);case 19:return e.abrupt("return",e.sent);case 22:if(e.prev=22,e.t0=e["catch"](6),console.log("Error in _csrfAwareFetch",(0,i.Z)(e.t0),e.t0),"Network request failed"!==e.t0.message){e.next=27;break}return e.abrupt("return",new Response(null,{status:503,statusText:"Service unavailable due to network error"}));case 27:throw e.t0;case 28:case"end":return e.stop()}}),e,this,[[6,22]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"_loadModels",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n,r,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t="asset-link-cached-entity-models",e.next=3,this._store.getItem(t);case 3:if(n=e.sent,!n){e.next=6;break}return e.abrupt("return",n.value);case 6:return e.next=8,this._loadModelsFromServer();case 8:return r=e.sent,i=ae(),e.next=12,this._store.setItem(t,{key:t,timestamp:i,value:r});case 12:return e.abrupt("return",r);case 13:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_loadModelsFromServer",value:function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(){var t,n,i,s=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.viewModel.bootText="Loading server schema",e.next=3,xe((0,q.Z)("/api/schema"));case 3:return t=e.sent,n=t.allOf.flatMap((function(e){return e.links||[]})),i={},e.next=8,Promise.all(n.map(function(){var e=(0,a.Z)(regeneratorRuntime.mark((function e(t){var a,u,o,c,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,xe(t.targetSchema);case 2:return o=e.sent,e.next=5,xe(o.definitions.data.items.$ref);case 5:c=e.sent,l=c.definitions.type["const"],i[l]={attributes:Object.fromEntries(Object.entries(c.definitions.attributes.properties).map((function(e){var t=(0,r.Z)(e,2),n=t[0],i=t[1];return"integer"===i.type&&(i.type="number"),"third_party_settings"===n&&(i.type="object"),[n,i]}))),relationships:(null===(a=c.definitions)||void 0===a||null===(u=a.relationships)||void 0===u?void 0:u.properties)||{}},s.viewModel.bootProgress=(Object.keys(i).length/n.length*100).toFixed(1);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return e.abrupt("return",i);case 9:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()}]),e}()},7441:function(e,t,n){n.d(t,{Z:function(){return r}});n(1539),n(8783),n(3948),n(285),n(1637);function r(e){return new URL(e,window.location.origin+window.assetLinkDrupalBasePath)}},8787:function(e,t,n){var r=n(538),i=n(3428);r.Z.use(i.Z),t["Z"]=new i.Z({})},5597:function(e,t,n){var r=n(5205);(0,r.z)("".concat("/__THIS_GETS_REPLACED_AT_RUNTIME_BY_THE_DRUPAL_CONTROLLER__/","service-worker.js"),{ready:function(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered:function(){console.log("Service worker has been registered.")},cached:function(){console.log("Content has been cached for offline use.")},updatefound:function(){console.log("New content is downloading.")},updated:function(){console.log("New content is available; please refresh.")},offline:function(){console.log("No internet connection found. App is running in offline mode.")},error:function(e){console.error("Error during service worker registration:",e)}})}}]);
//# sourceMappingURL=chunk-common-legacy.js.map